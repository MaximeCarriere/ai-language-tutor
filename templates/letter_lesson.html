<!doctype html>
<html>
  <head>
    <title>Letter Lesson</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 16px;
      }
      .font-sample { font-size: 64px; margin: 8px 0; }
      .section { border: 1px solid #ccc; padding: 16px; margin-bottom: 24px; border-radius: 8px; }
      .phoneme-box, .word-box { margin-top: 16px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
      .result { background: #f5f5f5; padding: 8px; border-radius: 4px; margin-top: 8px; }
      .small-btn { font-size: 0.85em; padding: 6px 10px; margin-right: 6px; cursor: pointer; }
      pre { overflow: auto; }
      .highlight-letter { color: red; }
      .feedback-text { white-space: pre-wrap; }
      .exercise-box { border: 1px dashed #888; padding: 12px; margin-bottom: 16px; border-radius: 6px; }
      .choices { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
      .choice-btn { padding: 8px 14px; border: 1px solid #444; border-radius: 4px; background: #f0f0f0; cursor: pointer; }
      .choice-btn.correct { background: #c8f7c5; border-color: #2e7d32; }
      .choice-btn.wrong { background: #f7c5c5; border-color: #c62828; }
      .hidden { display: none; }
    </style>
  </head>
  <body>
    <h1>Letter Lesson: {{ letter }}</h1>
    <a href="/">← Home</a>

    <!-- New button to jump to exercises for this letter -->
    <div style="margin:12px 0;">
        <a href="/letter_exercise/?letter={{ letter }}">
          <button class="small-btn">Start Exercises for "{{ letter }}"</button>
        </a>
    </div>

    {% if message %}
      <div style="background:#fff4e5; padding:10px; border:1px solid #f1c27d; border-radius:5px; margin:12px 0;">
        <strong>Note:</strong> {{ message }}
      </div>
    {% endif %}

    <!-- Intro -->
    <div class="section">
      <h2>Introduction</h2>
      <p id="intro-text">{{ intro }}</p>
      <button id="play-intro" class="small-btn">Play Intro</button>
    </div>

    <!-- Visual recognition -->
    <div class="section">
      <h2>See the Letter</h2>
      <p>Uppercase / lowercase in different fonts (target letter in red):</p>
      {% for f in fonts %}
        <div class="font-sample" style="font-family: {{ f }};">
          <span class="highlight-letter">{{ letter }}</span>
          <span class="highlight-letter">{{ letter | lower }}</span>
        </div>
      {% endfor %}
    </div>

    <!-- All phoneme reference -->
    <div class="section">
      <h2>All Sounds of "{{ letter }}"</h2>
      <p>This letter can make multiple sounds. Here are common pronunciations with example words:</p>
      <ul>
        {% for p in lesson.all_phonemes %}
          <li>
            <strong>{{ p.symbol }}</strong> — as in "{{ p.example }}"
            <button type="button" class="small-btn" onclick="speakText('The sound {{ p.symbol }}, as in {{ p.example }}.')">
              Play Example
            </button>
          </li>
        {% endfor %}
        {% if not lesson.all_phonemes %}
          <li>No expanded phoneme list available for this letter.</li>
        {% endif %}
      </ul>
    </div>

    <!-- Phoneme drills -->
    <div class="section">
      <h2>Phoneme Practice</h2>
      {% for p in phonemes %}
        <div class="phoneme-box">
          <h3>Sound: {{ p.symbol }} (as in "{{ p.example }}")</h3>

          <button type="button" class="small-btn" onclick="speakText('Focus on the sound {{ p.symbol }} as in {{ p.example }}.')">
            Play Instruction
          </button>

          <form method="post" enctype="multipart/form-data" style="margin-top:8px;">
            <input type="hidden" name="sub" value="phoneme">
            <input type="hidden" name="symbol" value="{{ p.symbol }}">
            <div style="display:flex; gap:12px; flex-wrap:wrap;">
              <div>
                <label>Your attempt (text):</label><br>
                <input name="phoneme_attempt" value="">
              </div>
              <div>
                <label>Or upload audio:</label><br>
                <input type="file" name="phoneme_audio" accept="audio/*">
              </div>
              <div style="align-self:flex-end;">
                <button type="submit">Submit Phoneme</button>
              </div>
            </div>
          </form>

          {% if phoneme_result and phoneme_result.target_phoneme == p.symbol %}
            <div class="result">
              {% set combined = phoneme_result.feedback %}
              <div class="feedback-text">
                <strong>Feedback:</strong> {{ combined }}
              </div>
              <div style="margin-top:6px;">
                <button type="button" class="small-btn"
                  data-text="{{ combined | e }}"
                  onclick="speakText(this.dataset.text)">
                  Play Combined Feedback
                </button>
              </div>
              <pre>{{ phoneme_result | tojson(indent=2) }}</pre>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <!-- Word drills -->
    <div class="section">
      <h2>Word Practice</h2>
      {% for w in words %}
        <div class="word-box">
          <h3>Word: {{ w.word }}</h3>
          <p><em>Example sentence:</em> {{ w.example_sentence }}</p>

          <button type="button" class="small-btn" onclick="speakText('Practice saying the word {{ w.word }}. {{ w.example_sentence }}')">
            Play Instruction
          </button>

          <form method="post" enctype="multipart/form-data" style="margin-top:8px;">
            <input type="hidden" name="sub" value="word">
            <input type="hidden" name="word" value="{{ w.word }}">
            <div style="display:flex; gap:12px; flex-wrap:wrap;">
              <div>
                <label>Your attempt (text):</label><br>
                <input name="word_attempt" value="">
              </div>
              <div>
                <label>Or upload audio:</label><br>
                <input type="file" name="word_audio" accept="audio/*">
              </div>
              <div style="align-self:flex-end;">
                <button type="submit">Submit Word</button>
              </div>
            </div>
          </form>

          {% if word_result and word_result.word == w.word %}
            <div class="result">
              <pre>{{ word_result | tojson(indent=2) }}</pre>
              {% if word_result.pronunciation_feedback %}
                <button type="button" class="small-btn"
                  data-feedback="{{ word_result.pronunciation_feedback | replace('"','&quot;') | replace("'", '&#39;') }}"
                  onclick="speakText(this.dataset.feedback)">
                  Play Feedback
                </button>
              {% endif %}
              {% if word_result.next_prompt %}
                <button type="button" class="small-btn"
                  data-next="{{ word_result.next_prompt | replace('"','&quot;') | replace("'", '&#39;') }}"
                  onclick="speakText(this.dataset.next)">
                  Play Next Prompt
                </button>
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    <script>
      function speakText(text) {
        if (!text) return;
        // sanitize stray JSON escapes visually
        try {
          text = text.replace(/\\u2018/g, "‘").replace(/\\u2019/g, "’").replace(/\\u00e6/g, "æ");
        } catch (e) {}
        console.log("TTS speaking:", text);
        if ('speechSynthesis' in window) {
          const utter = new SpeechSynthesisUtterance(text);
          utter.lang = 'en-US';
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(utter);
        } else {
          alert(text);
        }
      }

      document.getElementById("play-intro")?.addEventListener("click", () => {
        const text = document.getElementById("intro-text")?.textContent || "";
        speakText(text);
      });
    </script>
  </body>
</html>
