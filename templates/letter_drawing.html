<!doctype html>
<html>
<head>
    <title>Letter Drawing Practice</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; max-width: 900px; margin: 0 auto; padding: 16px; }
        .container { text-align: center; }
        #drawing-canvas { border: 2px solid #333; cursor: crosshair; touch-action: none; border-radius: 8px; }
        .controls { margin: 16px 0; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; align-items: center; }
        .btn { padding: 10px 18px; font-size: 1em; cursor: pointer; border-radius: 6px; border: 1px solid #444; }
        .btn-primary { background: #007bff; color: white; border-color: #007bff; }
        .btn-secondary { background: #6c757d; color: white; border-color: #6c757d; }
        #feedback-box { margin-top: 20px; padding: 16px; background: #f0f5ff; border: 1px solid #cce; border-radius: 8px; min-height: 50px; text-align: left; }
        #letter-selector, #voice-selector { padding: 8px; font-size: 1.1em; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Letter Drawing Practice</h1>
        <a href="/">‚Üê Home</a>

        <div class="controls">
            <div>
                <label for="letter-selector" style="font-weight: bold;">Letter to practice: </label>
                <select id="letter-selector">
                    <script>
                        for (let i = 65; i <= 90; i++) {
                            const letter = String.fromCharCode(i);
                            document.write(`<option value="${letter}">${letter}</option>`);
                        }
                    </script>
                </select>
            </div>
            <div>
                <label for="voice-selector" style="font-weight: bold;">Voice: </label>
                <select id="voice-selector"><option>Loading voices...</option></select>
            </div>
        </div>

        <canvas id="drawing-canvas" width="400" height="400"></canvas>

        <div class="controls">
            <button id="clear-btn" class="btn btn-secondary">Clear</button>
            <button id="submit-btn" class="btn btn-primary">Get Feedback</button>
        </div>

        <div id="feedback-box">
            <p>Draw the selected letter in the box and click "Get Feedback".</p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        const clearBtn = document.getElementById('clear-btn');
        const submitBtn = document.getElementById('submit-btn');
        const feedbackBox = document.getElementById('feedback-box');
        const letterSelector = document.getElementById('letter-selector');
        const voiceSelector = document.getElementById('voice-selector');

        let isDrawing = false;
        let voices = [];

        // --- UPDATED JAVASCRIPT ---

        function populateVoiceList() {
            voices = speechSynthesis.getVoices();
            voiceSelector.innerHTML = '';
            if (voices.length === 0) {
                voiceSelector.innerHTML = '<option>No voices available</option>';
                return;
            }
            voices.forEach((voice, i) => {
                if (voice.lang.startsWith('en')) { // Only show English voices
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.setAttribute('data-name', voice.name);
                    voiceSelector.appendChild(option);
                }
            });
        }
        
        // Populate voices when they are loaded
        populateVoiceList();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        function speakText(text) {
            if (!text || !('speechSynthesis' in window)) return;
            
            // Trick to make it say "A" instead of "capital A"
            const textToSpeak = text.length === 1 ? `${text}.` : text;

            const utter = new SpeechSynthesisUtterance(textToSpeak);
            const selectedVoiceName = voiceSelector.selectedOptions[0].getAttribute('data-name');
            const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);
            
            if (selectedVoice) {
                utter.voice = selectedVoice;
            }
            
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        }

        // --- The rest of the drawing logic remains the same ---
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 12;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        function getEventPosition(event) {
            const rect = canvas.getBoundingClientRect();
            if (event.touches && event.touches.length > 0) {
                return { x: event.touches[0].clientX - rect.left, y: event.touches[0].clientY - rect.top };
            }
            return { x: event.clientX - rect.left, y: event.clientY - rect.top };
        }
        
        function startDrawing(e) { e.preventDefault(); isDrawing = true; const pos = getEventPosition(e); [lastX, lastY] = [pos.x, pos.y]; }
        function draw(e) { if (!isDrawing) return; e.preventDefault(); const pos = getEventPosition(e); ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(pos.x, pos.y); ctx.stroke(); [lastX, lastY] = [pos.x, pos.y]; }
        function stopDrawing() { isDrawing = false; }
        function clearCanvas() { ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height); feedbackBox.innerHTML = '<p>Canvas cleared. Try again!</p>'; }

        async function submitDrawing() {
            const imageDataUrl = canvas.toDataURL('image/png');
            const letter = letterSelector.value;
            feedbackBox.innerHTML = '<p>Getting feedback from the AI tutor...</p>';
            submitBtn.disabled = true;
            try {
                const response = await fetch('/letter_drawing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image_data: imageDataUrl, letter: letter })
                });
                if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                const result = await response.json();
                let feedbackHTML = `<h3>Feedback for "${letter}"</h3>`;
                const recognized = result.recognized_letter || 'Not sure';
                feedbackHTML += `<p><strong>AI says it looks like:</strong> ${recognized} <button onclick="speakText('${recognized}')" style="margin-left:8px;">Hear</button></p>`;
                feedbackHTML += `<p style="margin-top: 16px;"><strong>Feedback:</strong> ${result.feedback || 'Could not get feedback.'}</p>`;
                if (result.is_correct) {
                     feedbackHTML += `<p style="color: green; font-weight: bold;">Great job, that's a good "${letter}"!</p>`;
                } else {
                     feedbackHTML += `<p style="color: red; font-weight: bold;">That's a good try! Let's work on it.</p>`;
                }
                feedbackBox.innerHTML = feedbackHTML;
            } catch (error) {
                console.error('Error:', error);
                feedbackBox.innerHTML = '<p>Sorry, something went wrong. Please try again.</p>';
            } finally {
                submitBtn.disabled = false;
            }
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        clearBtn.addEventListener('click', clearCanvas);
        submitBtn.addEventListener('click', submitDrawing);
    </script>
</body>
</html>
