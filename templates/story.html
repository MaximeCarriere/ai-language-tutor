<!doctype html>
<html lang="{{ lang_code }}" dir="{{ lang_config.direction }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t.story_weaver_title }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: {{ lang_config.font | safe }}; background-color: #f0f4f8; color: #34495e; margin: 0; padding: 24px; }
        .main-container { max-width: 800px; margin: 0 auto; display: grid; gap: 24px; }
        .header { text-align: center; }
        h1 { color: #2c3e50; font-size: 2.5em; margin: 0; }
        h2 { color: #2c3e50; margin-top: 0; padding-bottom: 8px; }
        .home-link { display: inline-block; margin-top: 8px; color: #3498db; text-decoration: none; font-weight: 700; }
        .card { background: #ffffff; border-radius: 24px; padding: 24px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); }
        .instructions { text-align: center; font-size: 1.1em; color: #7f8c8d; }
        .image-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 16px; margin-top: 16px; }
        .gallery-item { cursor: pointer; border: 4px solid transparent; border-radius: 20px; padding: 5px; transition: all 0.2s ease; text-align: center; }
        .gallery-item.selected { border-color: #3498db; background-color: #eaf5ff; }
        .gallery-item img { width: 100%; height: auto; border-radius: 16px; }
        .gallery-item p { margin: 8px 0 0 0; font-weight: 700; }
        .upload-section label { display: block; font-weight: 700; margin-bottom: 8px; }
        input[type="file"] { font-family: inherit; font-size: 1em; padding: 12px; border-radius: 12px; border: 2px dashed #ccc; width: 100%; }
        #preview-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        #preview-container img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .button-submit { font-family: 'Nunito', sans-serif; color: white; border: none; padding: 16px 24px; border-radius: 16px; font-size: 1.3em; font-weight: 700; cursor: pointer; transition: all 0.1s ease-in-out; width: 100%; margin-top: 24px; background-color: #e67e22; box-shadow: 0 4px 0 #d35400; }
        .button-submit:hover { background-color: #d35400; transform: translateY(-1px); }
        .story-display h2 { border-bottom: 2px solid #ecf0f1; }
        .story-display p { font-size: 1.2em; line-height: 1.7; white-space: pre-wrap; }
        .story-controls { display: flex; align-items: center; gap: 20px; margin-top: 16px; flex-wrap: wrap; }
        .control-group label { font-weight: 700; }
        select { font-family: inherit; padding: 8px 12px; font-size: 1em; border-radius: 8px; border: 2px solid #ccc; background-color: #fff; }
        .button-listen { font-family: 'Nunito', sans-serif; color: white; border: none; padding: 10px 16px; border-radius: 12px; font-size: 1em; font-weight: 700; cursor: pointer; background-color: #3498db; box-shadow: 0 4px 0 #2980b9; }
        pre { background-color: #ecf0f1; padding: 15px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; text-align: left; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <h1>{{ t.story_weaver_title }}</h1>
            <a href="/?lang={{ lang_code }}" class="home-link">‚Üê {{ t.back_to_home }}</a>
        </div>

        <form method="post" enctype="multipart/form-data" action="?lang={{ lang_code }}">
            <div class="card">
                <div class="instructions">
                    <p>{{ t.story_instruction_1 }}<br>{{ t.story_instruction_2 }}</p>
                </div>
                <div class="image-gallery">
                    {% for image in story_images %}
                    <div class="gallery-item" data-id="{{ image.id }}">
                        <img src="/static/images/{{ image.file }}" alt="{{ image.name }}">
                        <p>{{ image.name }}</p>
                        <input type="checkbox" name="selected_items" value="{{ image.id }}" style="display: none;">
                    </div>
                    {% endfor %}
                </div>
                <hr style="margin: 24px 0; border: 1px dashed #e0e0e0;">
                <div class="upload-section">
                    <label for="user-image-upload">{{ t.story_instruction_3 }}</label>
                    <input type="file" name="user_images" multiple accept="image/*" id="user-image-upload">
                    <div id="preview-container"></div>
                </div>
                
                <button type="submit" class="button-submit">{{ t.create_story_button }}</button>
            </div>
        </form>

        {% if story_result %}
        <div class="card story-display">
            <h2>{{ story_result.title }}</h2>
            <p id="story-text">{{ story_result.story_text }}</p>
            <div class="story-controls">
                <button type="button" class="button-listen" id="hear-story-btn">üîä {{ t.read_story_button }}</button>
                <div class="control-group">
                    <label for="voice-selector">{{ t.tutors_voice }}:</label>
                    <select id="voice-selector"></select>
                </div>
            </div>
        </div>
        {% elif raw_feedback %}
        <div class="card">
            <h2>Error</h2>
            <pre>{{ raw_feedback }}</pre>
        </div>
        {% endif %}
    </div>

    <script>
        // --- Form Interaction Logic ---
        document.querySelectorAll('.gallery-item').forEach(item => {
            item.addEventListener('click', () => {
                item.classList.toggle('selected');
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
            });
        });

        const imageUploadInput = document.getElementById('user-image-upload');
        const previewContainer = document.getElementById('preview-container');
        imageUploadInput.addEventListener('change', () => {
            previewContainer.innerHTML = '';
            for (const file of imageUploadInput.files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        });

        // --- Text-to-Speech Logic ---
        const hearStoryBtn = document.getElementById('hear-story-btn');
        const voiceSelector = document.getElementById('voice-selector');
        const langConfig = {{ lang_config | tojson }};
        let voices = [];

        function populateVoiceList() {
            if (!('speechSynthesis' in window)) return;
            voices = speechSynthesis.getVoices();
            voiceSelector.innerHTML = '';
            const langVoices = voices.filter(voice => voice.lang.startsWith(langConfig.code.split('-')[0]));

            if (langVoices.length === 0) {
                 voiceSelector.innerHTML = '<option>No voices available</option>';
                 return;
            }

            langVoices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.setAttribute('data-name', voice.name);
                voiceSelector.appendChild(option);
            });
        }

        function speakText(text) {
            if (!text || !('speechSynthesis' in window)) return;
            
            const utter = new SpeechSynthesisUtterance(text);
            const selectedVoiceName = voiceSelector.selectedOptions[0]?.getAttribute('data-name');
            const selectedVoice = voices.find(voice => voice.name === selectedVoiceName);

            utter.voice = selectedVoice;
            utter.lang = langConfig.code;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        }
        
        if (hearStoryBtn) {
            hearStoryBtn.addEventListener('click', () => {
                const storyText = document.getElementById('story-text').innerText;
                speakText(storyText);
            });
            // Populate voices when the page loads
            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }
        }
    </script>
</body>
</html>
